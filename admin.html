<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (ROOT)</title>
    <link rel="stylesheet" href="style.css">
    <style>.container { max-width: 900px; }</style>
</head>
<body>
    <div class="container">
        <div id="adminLogin">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
            <input type="email" id="adminEmail" placeholder="USER_ID">
            <input type="password" id="adminPass" placeholder="PASSPHRASE">
            <button id="authBtn">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="adminPanel" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalCount">0</span>
                    <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="todayCount">0</span>
                    <span class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
                </div>
                <div class="stat-card" style="border-color: var(--danger-red);">
                    <span class="stat-number" id="bannedCount" style="color:var(--danger-red);">0</span>
                    <span class="stat-label">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
                <h3 style="margin:0; color:#fff;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</h3>
                <button onclick="loadData()" style="width:auto; margin:0; font-size:0.9rem;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â†»</button>
            </div>
            
            <div id="requestsList" style="text-align: right;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('authBtn').addEventListener('click', () => {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPass').value;
            if(e === "mm@mm.mm" && p === "mm023123") {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadData();
            } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!"); }
        });

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± [16]
        async function banUser(ip) {
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† IP: ${ip}ØŸ\nÙ„Ù† ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!`)) return;
            
            const { error } = await _supabase.from('banned_ips').insert([{ ip: ip }]);
            if(error) {
                alert("Ø®Ø·Ø£: Ø±Ø¨Ù…Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù€ IP Ù…Ø­Ø¸ÙˆØ± Ø¨Ø§Ù„ÙØ¹Ù„.");
            } else {
                alert("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­! ğŸš«");
                loadData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
        async function deleteRequest(id) {
            if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            await _supabase.from('requests').delete().eq('id', id);
            loadData();
        }

        async function loadData() {
            const list = document.getElementById('requestsList');
            list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            const { data: requests } = await _supabase.from('requests').select('*').order('created_at', {ascending:false});
            
            // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† (Ù„Ù„Ø¹Ø¯Ø§Ø¯)
            const { count: bannedCount } = await _supabase.from('banned_ips').select('*', { count: 'exact', head: true });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª [15]
            if(requests) {
                document.getElementById('totalCount').innerText = requests.length;
                document.getElementById('bannedCount').innerText = bannedCount || 0;
                
                // Ø­Ø³Ø§Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…
                const today = new Date().toISOString().split('T')[0];
                const todayReqs = requests.filter(r => r.created_at.startsWith(today)).length;
                document.getElementById('todayCount').innerText = todayReqs;

                // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                list.innerHTML = '';
                requests.forEach(r => {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ IP Ù…Ù† Ø§Ù„Ù†Øµ (Ù„Ø£Ù†Ù‡ Ù…Ø­ÙÙˆØ¸ Ø¯Ø§Ø®Ù„ user_data)
                    // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: "Ø§Ù„Ù†Ø¸Ø§Ù…: [...] | IP: 123.123.123.123"
                    const ipMatch = r.user_data.match(/IP: ([\d\.]+)/);
                    const userIP = ipMatch ? ipMatch[1] : 'Unknown';

                    const d = new Date(r.created_at).toLocaleString('ar-EG');
                    const div = document.createElement('div');
                    div.style.cssText = "background:#050505; border:1px solid #333; padding:20px; margin-bottom:15px; border-right: 4px solid #0f0;";
                    div.innerHTML = `
                        <div style="color:#666; font-size:0.8rem; margin-bottom:10px; font-family:'Fira Code'; display:flex; justify-content:space-between;">
                            <span>${d}</span>
                            <span style="color:#fff;">IP: ${userIP}</span>
                        </div>
                        <div style="background:#111; padding:15px; white-space:pre-wrap; color:#fff; margin-bottom:10px;">${r.user_data}</div>
                        <p>Ø§Ù„ÙƒÙˆØ¯: <span style="color:#0f0; font-weight:bold; font-family:'Fira Code'; font-size:1.2rem;">${r.generated_code}</span></p>
                        
                        <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                            <a href="${r.reg_proof_url}" target="_blank"><img src="${r.reg_proof_url}" height="60" style="border:1px solid #555"></a>
                            <a href="${r.dep_proof_url}" target="_blank"><img src="${r.dep_proof_url}" height="60" style="border:1px solid #555"></a>
                        </div>
                        
                        <div style="margin-top:15px; border-top:1px dashed #333; padding-top:10px;">
                            <button class="action-btn ban-btn" onclick="banUser('${userIP}')">ğŸš« Ø­Ø¸Ø± IP</button>
                            <button class="action-btn delete-btn" onclick="deleteRequest(${r.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
            }
        }
    </script>
</body>
</html>
