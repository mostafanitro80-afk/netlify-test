<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Panel (ROOT)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="container wide-mode">
        <div id="adminLogin">
            <h2><i class="fa-solid fa-user-secret"></i> دخول الأدمن</h2>
            <div class="input-wrapper">
                <input type="password" id="adminPass" placeholder="أدخل كلمة المرور السرية..." style="text-align:center;">
            </div>
            <button onclick="checkAdmin()">دخول</button>
        </div>

        <div id="adminPanel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0;">لوحة القيادة</h2>
                <button onclick="fetchRequests()" style="width: auto; padding: 10px 20px; font-size: 0.9rem; margin:0;">
                    <i class="fa-solid fa-rotate"></i> تحديث
                </button>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                <div style="flex:1; background:#111; padding:15px; border-radius:8px; border:1px solid #333; text-align:center;">
                    <div style="font-size:2rem; font-weight:bold; color:var(--hacker-green);" id="countPending">0</div>
                    <div style="color:#777; font-size:0.8rem;">طلبات الانتظار</div>
                </div>
                <div style="flex:1; background:#111; padding:15px; border-radius:8px; border:1px solid #333; text-align:center;">
                    <div style="font-size:2rem; font-weight:bold; color:#fff;" id="countTotal">0</div>
                    <div style="color:#777; font-size:0.8rem;">إجمالي الطلبات</div>
                </div>
            </div>

            <div id="requestsGrid" class="requests-grid">
                <p style="grid-column: 1/-1; text-align: center; color: #555;">جاري تحميل البيانات...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function checkAdmin() {
            const p = document.getElementById('adminPass').value;
            // كلمة سر بسيطة (يمكنك تغييرها)
            if(p === "admin123" || p === "mm023123") {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                fetchRequests();
            } else { alert("رمز الدخول خاطئ!"); }
        }

        async function fetchRequests() {
            const grid = document.getElementById('requestsGrid');
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">جاري التحديث...</p>';

            const { data: requests, error } = await _supabase
                .from('requests')
                .select('*')
                .order('created_at', { ascending: false });

            const { data: activeCodes } = await _supabase.from('active_codes').select('*');

            if (error || !requests) {
                grid.innerHTML = '<p>خطأ في الاتصال</p>';
                return;
            }

            document.getElementById('countTotal').innerText = requests.length;
            document.getElementById('countPending').innerText = activeCodes.filter(c => !c.is_active).length;

            grid.innerHTML = '';

            requests.forEach(req => {
                // حالة التفعيل
                const codeStatus = activeCodes.find(c => c.code === req.generated_code);
                const isActive = codeStatus ? codeStatus.is_active : false;
                
                const card = document.createElement('div');
                card.className = 'request-card';
                card.style.borderColor = isActive ? 'var(--hacker-green)' : '#333';

                card.innerHTML = `
                    <div class="card-header">
                        <span>${new Date(req.created_at).toLocaleTimeString('ar-EG')}</span>
                        <span style="color: ${isActive ? 'var(--hacker-green)' : '#ffaa00'}">
                            ${isActive ? '● نشط' : '○ معلق'}
                        </span>
                    </div>
                    
                    <div class="card-body">${req.user_data}</div>
                    
                    <div style="margin-bottom:10px; font-family:'Fira Code'; font-weight:bold; color:var(--hacker-green);">
                        KEY: ${req.generated_code}
                    </div>

                    <div class="proof-imgs">
                        <a href="${req.reg_proof_url}" target="_blank" title="تسجيل"><img src="${req.reg_proof_url}"></a>
                        <a href="${req.dep_proof_url}" target="_blank" title="إيداع"><img src="${req.dep_proof_url}"></a>
                    </div>

                    <div class="action-bar">
                        ${!isActive ? 
                        `<button class="action-btn btn-approve" onclick="activate('${req.generated_code}')">
                            <i class="fa-solid fa-check"></i> تفعيل
                        </button>` : 
                        `<button class="action-btn" style="color:#555; cursor:default;">مفعل</button>`
                        }
                        
                        <button class="action-btn btn-ban" onclick="banUser('${req.user_data}')">
                            <i class="fa-solid fa-ban"></i> حظر
                        </button>
                        
                        <button class="action-btn btn-delete" onclick="delReq(${req.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function activate(code) {
            if(!confirm("تفعيل هذا الكود؟")) return;
            await _supabase.from('active_codes').update({ is_active: true }).eq('code', code);
            fetchRequests();
        }

        async function delReq(id) {
            if(!confirm("حذف السجل نهائياً؟")) return;
            await _supabase.from('requests').delete().eq('id', id);
            fetchRequests();
        }

        async function banUser(userData) {
            const match = userData.match(/IP: ([\d\.]+)/);
            if(match) {
                const ip = match[1];
                if(confirm(`حظر IP: ${ip}؟`)) {
                    await _supabase.from('banned_ips').insert([{ ip: ip }]);
                    alert("تم الحظر");
                }
            } else {
                alert("لم يتم العثور على IP في البيانات");
            }
        }
    </script>
</body>
</html>
