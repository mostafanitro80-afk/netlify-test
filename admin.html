<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>.container { max-width: 1000px; }</style>
</head>
<body>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="confirmTitle"></div>
            <div class="modal-msg" id="confirmMsg"></div>
            <div class="modal-actions"><button class="modal-btn" id="confirmOkBtn">Ù†Ø¹Ù…</button><button class="modal-btn cancel" onclick="closeConfirm()">Ø¥Ù„ØºØ§Ø¡</button></div>
        </div>
    </div>
    <div id="alertModal" class="modal-overlay"><div class="modal-box"><div class="modal-title" id="alertTitle"></div><div class="modal-msg" id="alertMsg"></div><div class="modal-actions"><button class="modal-btn" onclick="closeAlert()">Ù…ÙˆØ§ÙÙ‚</button></div></div></div>

    <div class="container">
        <div id="adminLogin">
            <h2 id="typewriterTitle"></h2>
            <input type="email" id="adminEmail" placeholder="USER_ID">
            <input type="password" id="adminPass" placeholder="PASSPHRASE">
            <button id="authBtn">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="adminPanel" class="hidden">
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-number" id="totalCount">0</span><span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></div>
                <div class="stat-card"><span class="stat-number" id="todayCount">0</span><span class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span></div>
                <div class="stat-card money"><span class="stat-number" id="totalRevenue" style="color:var(--warning-orange);">$0</span><span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ø¦Ø¯Ø§Øª [83]</span></div>
            </div>

            <div class="charts-container">
                <div class="chart-box"><canvas id="weeklyChart"></canvas></div>
                <div class="chart-box"><canvas id="systemChart"></canvas></div>
            </div>

            <div class="admin-toolbar">
                <input type="text" id="searchInput" class="search-input" placeholder="Ø¨Ø­Ø« (ID, Email, Code)..." onkeyup="filterData()">
                <select id="filterSelect" class="filter-select" onchange="filterData()">
                    <option value="all">Ø§Ù„ÙƒÙ„</option>
                    <option value="pending">Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</option>
                    <option value="active">Ø§Ù„Ù…ÙØ¹Ù„Ø©</option>
                </select>
                <button onclick="loadData()" style="width:auto; margin:0; padding:10px;">ØªØ­Ø¯ÙŠØ« â†»</button>
            </div>

            <div id="requestsList" style="text-align: right;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Setup
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let allRequests = []; // Store for filtering

        // Audio & FX
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) { if (audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); if (type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.start(); osc.stop(audioCtx.currentTime + 0.05); } }
        function typeWriter(text, elementId) { let i = 0; const target = document.getElementById(elementId); target.innerHTML = ""; function type() { if (i < text.length) { target.innerHTML += text.charAt(i); i++; setTimeout(type, 50); } } type(); }
        window.onload = () => typeWriter("Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù (ROOT)", "typewriterTitle");

        // Modal Logic
        function showAlert(t, m) { document.getElementById('alertTitle').innerText = t; document.getElementById('alertMsg').innerText = m; document.getElementById('alertModal').classList.add('active'); }
        function closeAlert() { document.getElementById('alertModal').classList.remove('active'); }
        let confirmCb = null;
        function showConfirm(t, m, cb) { document.getElementById('confirmTitle').innerText = t; document.getElementById('confirmMsg').innerText = m; confirmCb = cb; document.getElementById('confirmModal').classList.add('active'); }
        function closeConfirm() { document.getElementById('confirmModal').classList.remove('active'); }
        document.getElementById('confirmOkBtn').onclick = () => { if(confirmCb) confirmCb(); closeConfirm(); };

        // Auth
        document.getElementById('authBtn').addEventListener('click', () => {
            if(document.getElementById('adminEmail').value === "mm@mm.mm" && document.getElementById('adminPass').value === "mm023123") {
                document.getElementById('adminLogin').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); loadData();
            } else { showAlert("âŒ Ø®Ø·Ø£", "Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!"); }
        });

        // [83] Money & Activation
        async function activateCode(code, dbId) {
            let amount = prompt("ğŸ’° [83] Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ($):", "0");
            if(amount === null) return;
            
            showConfirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„", `ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ $${amount}ØŸ`, async () => {
                // Update Code status
                await _supabase.from('active_codes').update({ is_active: true }).eq('code', code);
                // Update Revenue in Request
                await _supabase.from('requests').update({ revenue: parseFloat(amount) || 0 }).eq('id', dbId);
                showAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº.");
                loadData();
            });
        }

        // [49] Edit Code
        async function editCode(oldCode, dbId) {
            let newCode = prompt("âœï¸ [49] ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹:", oldCode);
            if(newCode && newCode !== oldCode) {
                await _supabase.from('requests').update({ generated_code: newCode }).eq('id', dbId);
                await _supabase.from('active_codes').update({ code: newCode }).eq('code', oldCode);
                loadData();
            }
        }

        // [42] Save Note
        async function saveNote(id, val) {
            await _supabase.from('requests').update({ admin_note: val }).eq('id', id);
        }

        async function banUser(ip) { showConfirm("Ø­Ø¸Ø±", `Ø­Ø¸Ø± ${ip}ØŸ`, async () => { await _supabase.from('banned_ips').insert([{ ip: ip }]); showAlert("ØªÙ…", "ØªÙ… Ø§Ù„Ø­Ø¸Ø±"); loadData(); }); }
        async function deleteRequest(id) { showConfirm("Ø­Ø°Ù", "Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ", async () => { await _supabase.from('requests').delete().eq('id', id); loadData(); }); }

        // Data Loading
        async function loadData() {
            const list = document.getElementById('requestsList'); list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            const { data: requests } = await _supabase.from('requests').select('*').order('created_at', {ascending:false});
            const { data: activeCodes } = await _supabase.from('active_codes').select('*');
            
            if(requests) {
                // Merge active status
                allRequests = requests.map(r => {
                    const isActive = activeCodes.find(ac => ac.code === r.generated_code)?.is_active || false;
                    return { ...r, isActive };
                });
                
                updateStats(allRequests);
                renderList(allRequests);
            } else { list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>'; }
        }

        // [39] & [40] Filter Logic
        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterSelect').value;

            const filtered = allRequests.filter(r => {
                const matchesSearch = r.user_data.toLowerCase().includes(search) || r.generated_code.toLowerCase().includes(search);
                const matchesFilter = filter === 'all' ? true : (filter === 'active' ? r.isActive : !r.isActive);
                return matchesSearch && matchesFilter;
            });
            renderList(filtered);
        }

        function renderList(data) {
            const list = document.getElementById('requestsList'); list.innerHTML = '';
            data.forEach(r => {
                const ipMatch = r.user_data.match(/IP: ([\d\.]+)/);
                const userIP = ipMatch ? ipMatch[1] : 'Unknown';
                const d = new Date(r.created_at).toLocaleString('ar-EG');
                
                // [47] Device Info extraction (simplified)
                const device = r.device_info ? (r.device_info.includes('Mobile') ? 'ğŸ“± Mobile' : 'ğŸ’» PC') : 'Unknown';
                const country = r.country_code || 'UNK';

                const div = document.createElement('div');
                div.className = `request-card ${r.isActive ? '' : 'pending'}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; color:#666; font-size:0.8rem;">
                        <span>${d}</span>
                        <span>IP: ${userIP} [${country}] | ${device}</span>
                    </div>
                    <div style="background:#111; padding:10px; margin:10px 0; color:#fff; white-space:pre-wrap;">${r.user_data}</div>
                    
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:${r.isActive ? '#0f0' : 'orange'}">${r.isActive ? 'â— Ù…ÙØ¹Ù„' : 'â—‹ Ù…Ø¹Ù„Ù‚'}</span>
                        <code style="font-size:1.2rem; font-weight:bold; color:#fff;">${r.generated_code}</code>
                        <button onclick="editCode('${r.generated_code}', ${r.id})" style="width:auto; padding:2px 8px; font-size:0.7rem;">âœï¸ [49]</button>
                    </div>

                    <input type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† [42]..." value="${r.admin_note || ''}" 
                           onblur="saveNote(${r.id}, this.value)" 
                           style="margin-top:10px; padding:5px; background:#222; border:1px solid #444; color:#aaa;">

                    <div style="margin-top:15px; border-top:1px dashed #333; padding-top:10px;">
                        ${!r.isActive ? `<button class="action-btn activate-btn" onclick="activateCode('${r.generated_code}', ${r.id})">âœ… ØªÙØ¹ÙŠÙ„ ($)</button>` : ''}
                        <button class="action-btn ban-btn" onclick="banUser('${userIP}')">ğŸš« Ø­Ø¸Ø±</button>
                        <button class="action-btn delete-btn" onclick="deleteRequest(${r.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function updateStats(data) {
            // Money
            const totalRev = data.reduce((sum, r) => sum + (r.revenue || 0), 0);
            document.getElementById('totalRevenue').innerText = '$' + totalRev;
            document.getElementById('totalCount').innerText = data.length;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayCount').innerText = data.filter(r => r.created_at.startsWith(today)).length;

            // [81] Weekly Chart Data
            const ctx1 = document.getElementById('weeklyChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: { labels: ['A', 'B', 'C', 'D', 'E'], datasets: [{ label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª', data: [5, 12, 19, 3, 5], borderColor: '#0f0', tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // [82] System Pie Chart
            const sysCounts = { '1x':0, 'm':0, 'l':0 };
            data.forEach(r => { if(r.user_data.includes('1x')) sysCounts['1x']++; else if(r.user_data.includes('m')) sysCounts['m']++; else sysCounts['l']++; });
            
            const ctx2 = document.getElementById('systemChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: ['1xBet', 'Melbet', 'Linebet'], datasets: [{ data: [sysCounts['1x'], sysCounts['m'], sysCounts['l']], backgroundColor: ['#00f', '#fa0', '#0f0'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
