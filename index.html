<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة الدخول الآمنة | V9</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* =========================================
           تنسيقات الانترو الجديد (Crash Theme Intro)
        ========================================= */
        .intro-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-in-out;
        }
        
        /* اللوجو في الانترو */
        .intro-logo-box img {
            width: 120px;
            filter: drop-shadow(0 0 20px var(--hacker-green));
            animation: floatLogo 3s ease-in-out infinite;
        }
        @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* عداد المضاعف (Multiplier) */
        .crash-counter-box {
            margin-top: 30px;
            text-align: center;
            position: relative;
        }
        .crash-multiplier {
            font-family: 'Fira Code', monospace;
            font-size: 5rem;
            font-weight: 900;
            color: var(--hacker-green);
            text-shadow: 0 0 30px var(--hacker-green);
            transition: color 0.3s, text-shadow 0.3s;
        }
        /* حالة التحطم (Crash State) */
        .crash-multiplier.crashed {
            color: var(--danger-red);
            text-shadow: 0 0 50px var(--danger-red), 0 0 20px #fff;
            animation: crashShake 0.5s infinite;
        }
        @keyframes crashShake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .intro-status-text {
            font-family: 'Cairo', sans-serif;
            color: #888;
            margin-top: 20px;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        /* رسم بياني خلفي بسيط */
        .graph-line-container {
            position: absolute; top: 50%; left: 0; width: 100%; height: 200px;
            z-index: -1; opacity: 0.3; pointer-events: none; overflow: hidden;
        }
        .rising-graph-line {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, var(--hacker-green));
            clip-path: polygon(0 100%, 100% 100%, 100% 100%, 0 100%);
            transition: clip-path 3.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .intro-overlay.start-rise .rising-graph-line {
             clip-path: polygon(0 100%, 100% 20%, 100% 100%, 0 100%);
        }

        /* =========================================
           تعديلات الحاوية الرئيسية
        ========================================= */
        /* إخفاء الشاشة الرئيسية حتى انتهاء الانترو */
        #mainContainer { opacity: 0; transition: opacity 0.8s ease-in; }
        #mainContainer.fade-in { opacity: 1; }

    </style>
</head>
<body style="background:#000;">

    <div id="crashIntroOverlay" class="intro-overlay">
        <div class="intro-logo-box">
            <img src="11zon_cropped.png" alt="System Logo">
        </div>
        
        <div class="crash-counter-box">
            <div class="crash-multiplier" id="introMultiplier">1.00x</div>
        </div>

        <div class="intro-status-text" id="introStatus">جاري بدء تشغيل الأنظمة...</div>

        <div class="graph-line-container">
            <div class="rising-graph-line"></div>
        </div>
    </div>
    <div id="loginModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">[ تنبيه النظام ]</div>
            <div class="modal-msg" id="modalMsg">...</div>
            <div class="modal-actions"><button class="modal-btn" onclick="closeModal()">موافق</button></div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <img src="11zon_cropped.png" alt="App Logo" class="pro-logo" id="targetLogo">
        
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">بوابة الدخول</h2>
            <div style="font-family: 'Fira Code'; font-size: 0.7rem; color: #888; margin-top: 5px;">
                نظام تحليل النتائج V9 | الحالة: <span style="color:var(--hacker-green)">جاهز</span>
            </div>
        </div>
        
        <div class="input-wrapper">
            <input type="text" id="accessCode" placeholder="أدخل مفتاح الوصول (KEY)" 
                   style="text-align: center; font-weight: bold; font-family:'Fira Code'; letter-spacing:2px; text-transform:uppercase;">
        </div>

        <button id="loginBtn">دخول للنظام</button>
        <button class="secondary-btn" onclick="window.location.href='create.html'" style="width:100%;">طلب مفتاح جديد (تسجيل)</button>
        
        <div class="status-bar">
            <div class="status-item"><div class="blink-dot"></div> السيرفر: متصل</div>
            <div class="status-item">Ping: <span id="pingVal">45ms</span></div>
        </div>

        <p id="vpnWarning" style="color: var(--warning-orange); font-size: 0.8rem; margin-top: 10px; display: none; border: 1px dashed var(--warning-orange); padding: 5px;">
            ⚠️ تحذير أمني: تم كشف اتصال VPN. يرجى الحذر.
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // دالة تشغيل أصوات (للانترو والتنبيهات)
        function playTone(freq, type='sine', len=0.1, vol=0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + len);
        }

        // دالة تشغيل صوت متصاعد (للصاروخ)
        function playRisingTone(duration) {
             if (audioCtx.state === 'suspended') audioCtx.resume();
             const osc = audioCtx.createOscillator();
             const gain = audioCtx.createGain();
             osc.connect(gain); gain.connect(audioCtx.destination);
             osc.type = 'triangle';
             osc.frequency.setValueAtTime(200, audioCtx.currentTime);
             osc.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + duration);
             gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
             gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + duration);
             osc.start(); osc.stop(audioCtx.currentTime + duration + 0.1);
        }

        function showModal(title, msg) { document.getElementById('modalTitle').innerText = title; document.getElementById('modalMsg').innerText = msg; document.getElementById('loginModal').classList.add('active'); playTone(150, 'sawtooth', 0.3); }
        function closeModal() { document.getElementById('loginModal').classList.remove('active'); }
        function shakeScreen() { const c = document.getElementById('mainContainer'); c.classList.add('shake-element'); setTimeout(()=>c.classList.remove('shake-element'),500); }

        function checkVPN() {
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (timeZone !== "Africa/Cairo" && timeZone !== "Asia/Riyadh") { 
                document.getElementById('vpnWarning').style.display = 'block';
            }
        }

        setInterval(() => {
            document.getElementById('pingVal').innerText = Math.floor(Math.random() * 60 + 20) + 'ms';
        }, 2000);

        // ==================================================
        // === دالة الانترو الجديدة (Crash Intro Sequence) ===
        // ==================================================
        async function runCrashIntroSequence() {
            const introOverlay = document.getElementById('crashIntroOverlay');
            const multiplierEl = document.getElementById('introMultiplier');
            const statusEl = document.getElementById('introStatus');
            const mainContainer = document.getElementById('mainContainer');

            // تأخير بسيط قبل البدء
            await new Promise(r => setTimeout(r, 500));
            
            // بدء حركة الرسم البياني
            introOverlay.classList.add('start-rise');
            playRisingTone(3.5); // تشغيل صوت الصعود لمدة 3.5 ثانية

            let currentMulti = 1.00;
            let speed = 50;
            
            // حلقة زيادة العداد
            const riseInterval = setInterval(() => {
                // معادلة لزيادة السرعة كلما ارتفع الرقم
                currentMulti += (currentMulti * 0.015) + 0.01; 
                multiplierEl.innerText = currentMulti.toFixed(2) + "x";

                // تغيير النصوص أثناء الصعود
                if(currentMulti > 1.5 && currentMulti < 3) statusEl.innerText = "جاري الاتصال بالسيرفرات...";
                if(currentMulti > 3 && currentMulti < 6) statusEl.innerText = "مزامنة البيانات (Syncing)...";
                if(currentMulti > 6) statusEl.innerText = "تهيئة واجهة المستخدم...";

                // تسريع العداد
                if(currentMulti > 2.0) speed = 30;
                if(currentMulti > 5.0) speed = 20;
            }, speed);


            // لحظة الـ CRASH (بعد حوالي 3.5 ثانية)
            setTimeout(async () => {
                clearInterval(riseInterval); // إيقاف العداد
                
                // تأثير التحطم
                multiplierEl.classList.add('crashed');
                multiplierEl.innerText = "CRASHED!";
                statusEl.innerText = "تم الوصول للنظام بنجاح.";
                statusEl.style.color = "var(--danger-red)";
                
                // صوت التحطم
                playTone(100, 'sawtooth', 0.8, 0.3); 

                // الانتظار قليلاً لرؤية التحطم
                await new Promise(r => setTimeout(r, 1200));

                // إخفاء الانترو وإظهار صفحة الدخول
                introOverlay.style.opacity = '0';
                mainContainer.style.display = 'block';
                
                setTimeout(() => {
                    introOverlay.remove(); // حذف الانترو من الصفحة
                    mainContainer.classList.add('fade-in'); // إظهار ناعم لصفحة الدخول
                    playTone(600, 'sine', 0.2, 0.1); // صوت ترحيب خفيف
                }, 800);

            }, 3500); // مدة الصعود قبل التحطم
        }

        // التحقق من الحظر ثم تشغيل الانترو
        async function checkBan() {
            checkVPN();
            try {
                // التحقق السريع من الحظر (يمكنك تفعيله إذا أردت، حالياً سيتخطاه للانترو مباشرة)
                // const res = await fetch('https://api.ipify.org?format=json');
                // ... منطق التحقق ...
                 runCrashIntroSequence(); // تشغيل الانترو الجديد
            } catch (e) { 
                runCrashIntroSequence(); 
            }
        }
        window.onload = checkBan;

        async function runLogin() {
            const codeInput = document.getElementById('accessCode').value.trim();
            const btn = document.getElementById('loginBtn');
            if (!codeInput) { showModal("تنبيه", "يرجى إدخال الكود أولاً."); shakeScreen(); return; }
            
            btn.innerText = "جاري التحقق..."; btn.disabled = true;

            setTimeout(async () => {
                try {
                    const { data } = await _supabase.from('active_codes').select('*').eq('code', codeInput).single();
                    if (!data) {
                        showModal("فشل الدخول", "الكود غير صحيح أو غير موجود.");
                        shakeScreen();
                    } else if (data.is_active === true) {
                        localStorage.setItem('isLoggedIn', 'true'); window.location.href = 'app.html';
                    } else {
                        showModal("قيد الانتظار", "جاري المراجعه يرجى الانتظار.");
                    }
                } catch (err) { showModal("خطأ اتصال", "تعذر الاتصال بقاعدة البيانات."); shakeScreen(); } 
                finally { btn.innerText = "دخول للنظام"; btn.disabled = false; }
            }, 1000);
        }
        document.getElementById('loginBtn').addEventListener('click', runLogin);
    </script>
</body>
</html>
