<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="toast" class="custom-toast">
        <span id="toastIcon">âš ï¸</span>
        <span id="toastMessage">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§</span>
    </div>

    <div class="container">
        <h2>ğŸš€ Ø·Ù„Ø¨ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„</h2>
        
        <label class="title">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ:</label>
        <textarea id="userData" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ..."></textarea>

        <label class="title">Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
        <label for="regProof" class="upload-box" id="regBox">
            <span class="icon">ğŸ“·</span>
            <span id="regText">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
            <input type="file" id="regProof" accept="image/*" onchange="handleFileSelect(this, 'regBox', 'regText')">
        </label>

        <label class="title">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</label>
        <label for="depProof" class="upload-box" id="depBox">
            <span class="icon">ğŸ’°</span>
            <span id="depText">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</span>
            <input type="file" id="depProof" accept="image/*" onchange="handleFileSelect(this, 'depBox', 'depText')">
        </label>

        <button id="submitBtn">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù†</button>
        
        <div id="codeDisplay" class="hidden" style="margin-top: 20px;">
            <p style="color:#2ecc71; font-weight:bold;">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!</p>
            <div style="background:#222; padding:15px; border:1px dashed #2ecc71; border-radius:10px; margin:10px 0; color:#2ecc71; font-size:1.5rem; letter-spacing:2px;" id="generatedCode"></div>
            <button class="secondary-btn" onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø¨Ø¯ÙŠÙ„ Ø§Ù„Ù€ Alert) ---
        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMessage');
            const icon = document.getElementById('toastIcon');

            msg.innerText = message;
            toast.className = `custom-toast ${type} show`; // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ø¸Ù‡ÙˆØ±
            
            if(type === 'success') icon.innerText = 'âœ…';
            else icon.innerText = 'âš ï¸';

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // --- ÙˆØ¸ÙŠÙØ© ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© ---
        function handleFileSelect(input, boxId, textId) {
            const box = document.getElementById(boxId);
            const text = document.getElementById(textId);
            
            if (input.files && input.files[0]) {
                box.classList.add('uploaded');
                text.innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: " + input.files[0].name;
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¨Ø³ÙŠØ· Ø£Ùˆ Ø§Ù‡ØªØ²Ø§Ø² Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            }
        }

        // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±ÙØ¹ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ÙƒÙ† Ù…Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
        async function uploadImage(file) {
            const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const { data, error } = await _supabase.storage.from('proofs').upload(fileName, file, { upsert: false });
            if (error) throw error;
            const { data: publicUrlData } = _supabase.storage.from('proofs').getPublicUrl(fileName);
            return publicUrlData.publicUrl;
        }

        async function runSubmit() {
            const userData = document.getElementById('userData').value;
            const regProofFile = document.getElementById('regProof').files[0];
            const depProofFile = document.getElementById('depProof').files[0];
            const btn = document.getElementById('submitBtn');

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† alert
            if (!userData) { showToast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"); return; }
            if (!regProofFile) { showToast("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„"); return; }
            if (!depProofFile) { showToast("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹"); return; }

            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
            btn.disabled = true;

            try {
                const regUrl = await uploadImage(regProofFile);
                const depUrl = await uploadImage(depProofFile);
                const generatedCode = 'CODE-' + Math.floor(100000 + Math.random() * 900000);

                const { error: insertError } = await _supabase
                    .from('requests')
                    .insert([{ 
                        user_data: userData, reg_proof_url: regUrl, dep_proof_url: depUrl, generated_code: generatedCode
                    }]);
                if (insertError) throw insertError;

                const { error: codeError } = await _supabase.from('active_codes').insert([{ code: generatedCode }]);
                if (codeError) throw codeError;

                // Ù†Ø¬Ø§Ø­
                showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!", "success");
                document.getElementById('codeDisplay').classList.remove('hidden');
                document.getElementById('generatedCode').innerText = generatedCode;
                btn.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
                
            } catch (error) {
                console.error(error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message, "error");
                btn.innerHTML = "âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù†";
                btn.disabled = false;
            }
        }
        document.getElementById('submitBtn').addEventListener('click', runSubmit);
    </script>
</body>
</html>
